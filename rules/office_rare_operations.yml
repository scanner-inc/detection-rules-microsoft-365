# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: Office Rare Operations
description: |-
  Detect Office operations that are typically rare and can provide capabilities
  to attackers. These include mailbox permissions, inbox rules, and transport
  rule modifications.
enabled: true
severity: Low
query_text: |-
  @scnr.source_type:microsoft_365
  Operation:('Add-MailboxPermission' 'Add-MailboxFolderPermission' 'Set-Mailbox' 'New-ManagementRoleAssignment' 'New-InboxRule' 'Set-InboxRule' 'Set-TransportRule')
  (not userId:('NT AUTHORITY\\SYSTEM (Microsoft.Exchange.ServiceHost)' 'NT AUTHORITY\\SYSTEM (Microsoft.Exchange.AdminApi.NetCore)' 'NT AUTHORITY\\SYSTEM (w3wp)' 'devilfish-applicationaccount'))
  | groupbycount(UserId)
  | where @q.count > 0
time_range_s: 300
run_frequency_s: 60
event_sink_keys:
- low_severity_alerts
tags:
- tactics.ta0003.persistence
- tactics.ta0009.collection
- techniques.t1098.account_manipulation
- techniques.t1114.email_collection
- source.microsoft-365
